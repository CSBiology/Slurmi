<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
      <title>Writing a workflow </title>
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <meta name="title" content="Writing a workflow ">
      
      <link rel="icon" href="../favicon.ico">
      <link rel="stylesheet" href="../public/docfx.min.css">
      <link rel="stylesheet" href="../public/main.css">
      <meta name="docfx:navrel" content="../toc.html">
      <meta name="docfx:tocrel" content="toc.html">
      
      
      
      
      <meta name="docfx:docurl" content="https://github.com/CSBiology/Slurmi/blob/main/docs/docfx_project/articles/tutwf.md/#L1">
      <meta name="loc:inThisArticle" content="In this article">
      <meta name="loc:searchResultsCount" content="{count} results for &quot;{query}&quot;">
      <meta name="loc:searchNoResults" content="No results for &quot;{query}&quot;">
      <meta name="loc:tocFilter" content="Filter by title">
      <meta name="loc:nextArticle" content="Next">
      <meta name="loc:prevArticle" content="Previous">
      <meta name="loc:themeLight" content="Light">
      <meta name="loc:themeDark" content="Dark">
      <meta name="loc:themeAuto" content="Auto">
      <meta name="loc:changeTheme" content="Change theme">
      <meta name="loc:copy" content="Copy">
  </head>

  <script type="module">
    import options from './../public/main.js'
    import { init } from './../public/docfx.min.js'
    init(options)
  </script>

  <script>
    const theme = localStorage.getItem('theme') || 'auto'
    document.documentElement.setAttribute('data-bs-theme', theme === 'auto' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme)
  </script>


  <body class="tex2jax_ignore" data-layout="" data-yaml-mime="">
    <header class="bg-body border-bottom">
      <nav id="autocollapse" class="navbar navbar-expand-md" role="navigation">
        <div class="container-xxl flex-nowrap">
          <a class="navbar-brand" href="../index.html">
            <img id="logo" class="svg" src="../logo.svg" alt="">
            
          </a>
          <button class="btn btn-lg d-md-none border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navpanel" aria-controls="navpanel" aria-expanded="false" aria-label="Toggle navigation">
            <i class="bi bi-three-dots"></i>
          </button>
          <div class="collapse navbar-collapse" id="navpanel">
            <div id="navbar">
            </div>
          </div>
        </div>
      </nav>
    </header>

    <main class="container-xxl">
      <div class="toc-offcanvas">
        <div class="offcanvas-md offcanvas-start" tabindex="-1" id="tocOffcanvas" aria-labelledby="tocOffcanvasLabel">
          <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="tocOffcanvasLabel">Table of Contents</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#tocOffcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <nav class="toc" id="toc"></nav>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="actionbar">
          <button class="btn btn-lg border-0 d-md-none" style="margin-top: -.65em; margin-left: -.8em" type="button" data-bs-toggle="offcanvas" data-bs-target="#tocOffcanvas" aria-controls="tocOffcanvas" aria-expanded="false" aria-label="Show table of contents">
            <i class="bi bi-list"></i>
          </button>

          <nav id="breadcrumb"></nav>
        </div>

        <article data-uid="">
<h1 id="writing-a-workflow">Writing a workflow</h1>

<p>Developing a workflow is one of the key parts of using Slurmi.
Here, you define the sequential steps for completing the work.
Some of these steps are dependent on each other, and these dependencies are defined in the workflow.
To do this, you first create multiple jobs.</p>
<pre><code class="lang-fsharp">let j1 = Job (&quot;MyJob1&quot;,[(&quot;echo&quot;,[&quot;Hello&quot;;&quot;World&quot;])])
let j2 = Job (&quot;MyJob2&quot;,[(&quot;echo&quot;,[&quot;Hi&quot;;&quot;there&quot;])])
let j3 = Job (&quot;MyJob3&quot;,[(&quot;echo&quot;,[&quot;Hi&quot;;&quot;;&quot;;&quot;How are you?&quot;])])
let j4 = Job (&quot;MyJob4&quot;,[(&quot;echo&quot;,[&quot;Aloha&quot;])])
</code></pre>
<p>To incorporate these tasks into the workflow, they must be transformed into a JobWithDep type, and further details need to be included.
JobInfo contains the job itself, AllOrAny specifies whether all or any of the dependencies must be satisfied, and the dependencies are specified in the JobDependency type.
Each dependency is a tuple of the job name and the number of tasks that must be completed before the job can be started.
If there are no dependencies, an empty list is used.</p>
<pre><code class="lang-fsharp">let jd1 = {JobInfo = j1; AllOrAny = TypeOfDep.All; DependingOn = []}
let jd2 = {JobInfo = j2; AllOrAny = TypeOfDep.All; DependingOn = [(j1,KindOfDependency.Afterok )]}
let jd3 = {JobInfo = j3; AllOrAny = TypeOfDep.All; DependingOn = [(j1, KindOfDependency.Afterok)]}
let jd4 = {JobInfo = j4; AllOrAny = TypeOfDep.Any; DependingOn = [(j2, KindOfDependency.Afterok);(j3, KindOfDependency.Afterok)]}
</code></pre>
<p>In the next step, the jobs are combined into a list, allowing the simultaneous editing of multiple jobs.</p>
<pre><code class="lang-fsharp">[jd1;jd2;jd3;jd4]
|&gt; List.map (fun x -&gt; x.JobInfo.OneDash |&gt; ShortCommand.SetPartition &quot;bio-csb&quot;)

[jd1;jd2;jd3;jd4]
|&gt; List.map (fun x -&gt; x.JobInfo.TwoDashes |&gt; LongCommand.SetTime ({Days = None ; clock = Some {hour = 0; minute = 1; second = Some 1}}))
</code></pre>
<h2 id="creating-a-workflow">Creating a workflow</h2>
<p>The workflow can then be created by calling the <code>createWorkflow</code> function.</p>
<pre><code class="lang-fsharp">let resultGraph = createWorkflow [jd1;jd2;jd3;jd4]
</code></pre>
<h2 id="submitting-a-workflow">Submitting a workflow</h2>
<p>This workflow can now be submitted to the cluster. With this, all dependencies will be resolved and submitted in the correct order.</p>
<pre><code class="lang-fsharp">let workedOn =  new List&lt;string&gt;()

resultGraph.Graph.submitAll resultGraph.Graph.Graph workedOn
</code></pre>
<h2 id="visualisation">Visualisation</h2>
<p>The workflow graph can be displayed, for example using the CyGraph library.</p>
<pre><code class="lang-fsharp">let toFullCyGraph nodeKeyTransformer nodeDataTransformer edgeTransformer (fGraph : FGraph&lt;_,_,_&gt;) =
    CyGraph.initEmpty ()
    |&gt; CyGraph.withElements [
            for (nk1,nd1,nk2,nd2,e) in FGraph.toSeq fGraph do
                let nk1s = nodeKeyTransformer nk1
                let nk2s = nodeKeyTransformer nk2
                Elements.node nk1s [CyParam.label &lt;| nodeDataTransformer nd1]
                Elements.node nk2s [CyParam.label &lt;| nodeDataTransformer nd2]
                Elements.edge (sprintf &quot;%s_%s&quot; nk2s nk1s) nk2s nk1s (edgeTransformer e)
        ]
    |&gt; CyGraph.withStyle &quot;node&quot;     
        [
            CyParam.content =. CyParam.label
            CyParam.color &quot;#A00975&quot;
        ]
    |&gt; CyGraph.withStyle &quot;edge&quot;     
        [
            CyParam.Line.color =. CyParam.color
            CyParam.Curve.style &quot;bezier&quot;
            CyParam.Target.Arrow.shape &quot;triangle&quot;
            CyParam.Source.Arrow.shape &quot;circle&quot;
            CyParam.color &quot;#438AFE&quot;
        ]
    |&gt; CyGraph.withLayout (Layout.initCose &lt;| Layout.LayoutOptions.Cose(ComponentSpacing = 40, EdgeElasticity = 100))
    |&gt; CyGraph.withSize(1800, 800)



toFullCyGraph string (fun x -&gt; x.JobInfo.Name) (fun e -&gt; 
    [
        CyParam.label &lt;| e.ToString()
        match e with
        | After (value) -&gt; CyParam.color &quot;green&quot;
        | Afterany -&gt; CyParam.color &quot;turquoise&quot;
        | Afterburstbuffer -&gt; CyParam.color &quot;orange&quot;
        | Aftercorr -&gt; CyParam.color &quot;purple&quot;
        | Afternotok -&gt; CyParam.color &quot;blue&quot;
        | Afterok -&gt; CyParam.color &quot;red&quot;
        | Singleton -&gt; CyParam.color &quot;hotpink&quot;
        // | _ -&gt; CyParam.color &quot;black&quot;
    ]
) resultGraph.Graph.Graph
|&gt; CyGraph.withLayout(Layout.initCircle &lt;| Layout.LayoutOptions.Cose())        
|&gt; CyGraph.show
</code></pre>
<p>The Graph will look like this:</p>
<p><img src="../images/SlurmiWF.png" alt=" "></p>
</article>

        <div class="contribution d-print-none">
          <a href="https://github.com/CSBiology/Slurmi/blob/main/docs/docfx_project/articles/tutwf.md/#L1" class="edit-link">Edit this page</a>
        </div>

        <div class="next-article d-print-none border-top" id="nextArticle"></div>
        
      </div>

      <div class="affix">
        <nav id="affix"></nav>
      </div>
    </main>


    <footer class="border-top">
      <div class="container-xxl">
        <div class="flex-fill">
          <span>Made with <a href="https://dotnet.github.io/docfx">docfx</a></span>
        </div>
      </div>
    </footer>
  </body>
</html>